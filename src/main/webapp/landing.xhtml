<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:fb="http://www.facebook.com/2008/fbml">

    <f:view contentType="text/html">
        <h:head>
            <f:facet name="first">
                <meta content='text/html; charset=UTF-8' http-equiv="Content-Type"/>
                <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"/>
                <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
                <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
                <link rel="stylesheet" href="css/styles.css"/>
                <title>Login</title>
            </f:facet>
        </h:head>

        <h:body>
                      <script>
                function statusChangeCallback(response) {
                    console.log('statusChangeCallback');
                    console.log(response);
                    if (response.status === 'connected') {
                        login();
                    } else {
                        document.getElementById('status').innerHTML = 'Para continuar, inicie sesion con Facebook.';
                    }
                }
                
                
                function checkLoginState() {
                    FB.getLoginStatus(function (response) {
                        statusChangeCallback(response);
                    });
                }

                window.fbAsyncInit = function () {
                    FB.init({
                        appId: '1943608085935991',
                        cookie: true, // enable cookies to allow the server to access 
                        // the session
                        xfbml: true, // parse social plugins on this page
                        version: 'v3.2' // use graph api version 2.8
                    });
                    
                     FB.Event.subscribe("auth.logout", function() {
                         window.location.href = 'http://localhost:8080/proyecto/'; 
                     });

                    FB.getLoginStatus(function (response) {
                        statusChangeCallback(response);
                    });
                };
                (function (d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id))
                        return;
                    js = d.createElement(s);
                    js.id = id;
                    js.src = "https://connect.facebook.net/en_US/sdk.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));

                function login() {

                    FB.api('/me', function (response) {
                        alert('Successful login for: ' + response.name);
                        document.getElementById('status').innerHTML =
                                'Thanks for logging in, ' + response.name + '!';
                        window.location.href = 'http://localhost:8080/proyecto/faces/landing.xhtml';                    
                    });
                }
            </script>
            
            <script>
                window.fbAsyncInit = function () {
                    FB.init({
                        appId: '1943608085935991',
                        autoLogAppEvents: true,
                        xfbml: true,
                        version: 'v3.2'
                    });
                    
                    FB.getLoginStatus(function(response){
                    if(response.session){
                        alert("1");
                         top.location.href="faces/index.xhtml";
                    }
        });
        
                FB.getLoginStatus(function(response) {
                    alert("2");
                        statusChangeCallback(response);
        });   
                };

                (function (d, s, id) {
                    alert("3");
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) {
                        alert("4");
                        return;
                    }
                    js = d.createElement(s);
                    js.id = id;
                    alert(js.id);
                    js.src = "https://connect.facebook.net/en_US/sdk.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
                
                function statusChangeCallback(response){
         if(response.status === 'connected'){
             alert("5");
           alert("BeforeTestAPI");
           testAPI();
           console.log('Logged in and authenticated');
           setElements(true);
         } else {
           setElements(false);
             alert("6");
           console.log('Not authenticated');
         }
       }

       function checkLoginState() {
        FB.getLoginStatus(function(response) {
            alert("7");
          statusChangeCallback(response);
        });
      }

                function testAPI(){
                    alert("testAPI");
    FB.api('/me?fields=name,last_name,birthday,gender', function(response){
        if(response || !response.error){
            alert("8");
            buildProfile(response);
//            location.reload();
        }
    });
}

function buildProfile(user){
    alert('User1: ' + user);
//    alert('User2: ' + ${user.name});
    alert('User3: ' + user.name);
        let profile = 
          '<h3>'+user.name+'</h3>'
          +'<ul class="list-group">'+
            '<li class="list-group-item">'+'User ID: '+user.id+'</li>'+
            '<li class="list-group-item">'+'Name: '+user.name+'</li>'+
            '<li class="list-group-item">'+'Last Name: '+user.last_name+'</li>'+
            '<li class="list-group-item">'+'Birthday: '+user.birthday+'</li>'+
            '<li class="list-group-item">'+'Gender: '+user.gender+'</li>'+
          '</ul>'
          ;

        document.getElementById('profile').innerHTML = profile;
      }

                    
                    function setElements(isLoggedIn){
        if(isLoggedIn){
            alert("9");
          document.getElementById('logout').style.display = 'block';
          document.getElementById('profile').style.display = 'block';
          document.getElementById('fb-btn').style.display = 'none';
          document.getElementById('heading').style.display = 'none';
        } else {
            alert("10");
          document.getElementById('logout').style.display = 'none';
          document.getElementById('profile').style.display = 'none';
          document.getElementById('fb-btn').style.display = 'block';
          document.getElementById('heading').style.display = 'block';
        }
      }

                    function checkLoginState() {
                        FB.getLoginStatus(function (response) {
                            alert("11");
                            if(response.status==="unknown"){
                                location.reload();
                            }
                            statusChangeCallback(response);
                        });
                    }

            </script>
            
            <h:form>  
    <p:growl id="messages"/>
 
    <p:menubar>
        <p:submenu label="File" icon="pi pi-file">
            <p:submenu label="New" icon="pi pi-briefcase">
                <p:menuitem value="Project" url="#" />
                <p:menuitem value="Other" url="#" />
            </p:submenu>
            <p:menuitem value="Open" url="#" />
            <p:separator />
            <p:menuitem value="Quit" url="#" />
        </p:submenu>
 
        <p:submenu label="Edit" icon="pi pi-pencil">
            <p:menuitem value="Undo" url="#" icon="pi pi-angle-double-left" />
            <p:menuitem value="Redo" url="#" icon="pi pi-angle-double-right" />
        </p:submenu>
 
        <p:submenu label="Help" icon="pi pi-question">
            <p:menuitem value="Contents" url="#" />
            <p:submenu label="Search" icon="pi pi-search">
                <p:submenu label="Text">
                    <p:menuitem value="Workspace" url="#" />
                </p:submenu>
                <p:menuitem value="File" url="#" />
            </p:submenu>
        </p:submenu>
 
        <p:submenu label="Actions" icon="pi pi-cog">
            <p:submenu label="Ajax" icon="pi pi-refresh">
                <p:menuitem value="Save" action="#{menuView.save}" icon="pi pi-save" update="messages"/>
                <p:menuitem value="Update" action="#{menuView.update}" icon="pi pi-refresh" update="messages"/>
            </p:submenu>
            <p:submenu label="Non-Ajax" icon="pi pi-clone">
                <p:menuitem value="Delete" action="#{menuView.delete}" icon="pi pi-times" update="messages" ajax="false"/>
            </p:submenu>
        </p:submenu>
        
        <p:submenu label="Boot" icon="pi pi-pencil">
            <p:menuitem value="Boot" outcome="indexBot" />
            <p:menuitem value="Redo" url="#" icon="pi pi-angle-double-right" />
        </p:submenu>
 
        <p:menuitem value="Quit" url="http://www.primefaces.org" icon="pi pi-times" />
 
        <f:facet name="options">
            <p:inputText style="margin:1px 10px 1px 1px;" placeholder="Search"/>
          <fb:login-button size="large" onlogin="checkLoginState();" autologoutlink="true"> </fb:login-button>
        </f:facet>
    </p:menubar>
</h:form>

        </h:body>
    </f:view>
</html>

